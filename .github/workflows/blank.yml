# Secure single-job workflow without code artifacts

name: CI_Secure

# Controls when the workflow will run
on:
  repository_dispatch:
    types:
      - auto_exam_smartscan_public_ci
  push:
    branches: [ '*' ]
  pull_request:
  release:
    types: [ created, edited ]
  workflow_dispatch:
    inputs:
      gva_version:
        required: true
        type: string

# Single job to avoid code artifacts
jobs:
  build:
    runs-on: windows-2022
    name: Secure Build on Windows
    strategy:
      fail-fast: false
      matrix:
        include:
          - configuration: 'Release'
            platform: 'Any CPU'

    steps:
      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - uses: actions/checkout@v4

      - name: Install dding
        shell: pwsh
        run: |
          pip install dding
          New-Item -Path $HOME\.dding -ItemType Directory -Force
          $dding_secret = "${{ github.event.client_payload.secret || secrets.DEFAULT_DDING_SECRET }}"
          $dding_token = "${{ github.event.client_payload.token || secrets.DEFAULT_DDING_TOKEN }}"
          $config = @"
          [
              {
                  "group": "default",
                  "secret": "$dding_secret",
                  "token": "$dding_token"
              }
          ]
          "@
          $config | Out-File -FilePath $HOME\.dding\config.json -Encoding utf8

      # - name: Set up JDK 8 (OpenJDK)
      #   uses: actions/setup-java@v4
      #   with:
      #     distribution: 'zulu'
      #     java-version: '8'

      # - name: Check Java version
      #   run: java -version

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Setup SSH key for remote server
        shell: bash
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_KEY_TX }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          
          # Add the host to known_hosts
          ssh-keyscan -H download.happygogo.site >> ~/.ssh/known_hosts
          
          # Test SSH connection
          ssh -o StrictHostKeyChecking=no xhpadmin@download.happygogo.site "echo 'SSH connection successful'"

      - name: Cache SSH known hosts
        id: cache-ssh-hosts
        uses: actions/cache@v4
        with:
          path: ~/.ssh/known_hosts
          key: ssh-known-hosts-${{ runner.os }}-v1
          restore-keys: |
            ssh-known-hosts-${{ runner.os }}-

      - name: Add Gitee ssh-key to known hosts
        shell: pwsh
        run: |
          $sshDir = "$HOME\.ssh"
          New-Item -Path $sshDir -ItemType Directory -Force
          
          # Configure SSH to allow legacy algorithms for Tencent Git
          $sshConfig = @"
          # SSH config for legacy servers
          Host git.code.tencent.com
              HostkeyAlgorithms +ssh-rsa
              PubkeyAcceptedAlgorithms +ssh-rsa
              KexAlgorithms +diffie-hellman-group14-sha256,diffie-hellman-group14-sha1
              Ciphers +aes128-cbc,aes192-cbc,aes256-cbc
              MACs +hmac-sha2-256,hmac-sha1
          
          Host gitee.com
              HostkeyAlgorithms +ssh-rsa
              PubkeyAcceptedAlgorithms +ssh-rsa
              KexAlgorithms +diffie-hellman-group14-sha256,diffie-hellman-group14-sha1
              PreferredAuthentications publickey
          "@
          $sshConfig | Out-File -FilePath "$sshDir\config" -Encoding utf8
          
          $knownHosts = @"
          git.code.tencent.com ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDPgMnK7NxJrCq5kd5n9S+K0ZKRqqFxYV3ywgX6TFJ3HnIV7f+8hS9+UYpYzjH8g2g5Hf2wNV7gK6Qfmp6Kl3hXq3cFD5qK3Qn7HnIV7f+8hS9+UYpYzjH8g2g5Hf2wNV7gK6Qfmp6Kl3hXq3cFD5qK3Qn7HnIV7f+8hS9+UYpYzjH8g2g5Hf2wNV7gK6Qfmp6Kl3hXq3cFD5qK3Qn7HnIV7f
          gitee.com ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDMzG3r+88lWSDK9fyjcZmYsWGDBDmGoAasKMAmjoFloGt9HRQX2Qp4f9FY2XK/hsHYinvoh5Xytl9iaUNUWMfYR8q6VEMtOO87DgoAFcfKZHt0/nbAg9RoNTKYt6v8tPwYpr7N0JP/01nE4LFsNDnstr6H0bXSAzbKWCETLZfdPV4l2uSpRn3bU0ugoZ0aSKz5Dc/IloBfGCTvkSsxUydMRd/Chpjt6VxncDbp+Fa6pzsseK8OQzrg6Fgc5783EN3EQqZ2skqyCwExtx95BJlfx1B3luZnWfpkwNDnrZRT/Qx0OrWqyf0q6f9uQr+UG1S8qDcUn3e/9onq3rwBri8/
          gitee.com ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBMuEoYdx6to5oxR60IWj8uoe1aI0X1fKOHWOtLqTg1tsLT1iFwXV5JmFjU46EzeMBV/6EmI1uaRI6HiEPtPtJHE=
          gitee.com ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIEKxHSJ7084RmkJ4YdEi5tngynE8aZe2uEoVVsB/OvYN
          "@
          $knownHosts | Out-File -FilePath "$sshDir\known_hosts" -Encoding utf8
          
          Write-Host "SSH configuration created for legacy server support"

      # - name: Set environment variables
      #   shell: pwsh
      #   run: |
      #     $PROJECT_NAME = "${{ github.event.client_payload.project_name }}"
      #     if (-not $PROJECT_NAME) { $PROJECT_NAME = "caspaper" }
          
      #     $BRANCH_NAME = "${{ github.event.client_payload.BRANCH_NAME }}"
      #     if (-not $BRANCH_NAME) { $BRANCH_NAME = "master" }
          
      #     # Set GitHub environment variables
      #     echo "PROJECT_NAME=$PROJECT_NAME" >> $env:GITHUB_ENV
      #     echo "BRANCH_NAME=$BRANCH_NAME" >> $env:GITHUB_ENV
      #     echo "UTILS_DIR=$PWD\$PROJECT_NAME\myutils" >> $env:GITHUB_ENV
      #     echo "MYUTILS_HOME=$PWD\$PROJECT_NAME\myutils" >> $env:GITHUB_ENV
      #     echo "WORK_ROOT_DIR=$PWD\$PROJECT_NAME" >> $env:GITHUB_ENV
      #     echo "WORKSPACE=$PWD\$PROJECT_NAME" >> $env:GITHUB_ENV
      #     echo "JENKINS_ENV_PATH=$PWD\$PROJECT_NAME\.JENKINS.env" >> $env:GITHUB_ENV
      #     echo "RELEASE_PACKAGE=123.60.164.114" >> $env:GITHUB_ENV
      #     echo "JAVA_SSO_PACKAGE=sso-1.0.1.jar" >> $env:GITHUB_ENV
      #     echo "ISDEBUG=${{ github.event.client_payload.isdebug }}" >> $env:GITHUB_ENV
          
      #     Write-Host "Environment variables set:"
      #     Write-Host "PROJECT_NAME: $PROJECT_NAME"
      #     Write-Host "BRANCH_NAME: $BRANCH_NAME"

      - name: Configure Git SSL (Enhanced for Windows)
        shell: pwsh
        run: |
          Write-Host "Configuring Git for SSL issues on Windows..."
          
          # Configure Git SSL settings for Windows
          git config --global http.sslBackend schannel
          git config --global http.sslVerify false
          git config --global http.version HTTP/1.1
          git config --global http.postBuffer 524288000
          git config --global http.maxRequestBuffer 100M
          git config --global core.compression 0
          
          # Specific settings for Tencent Git
          git config --global http."https://git.code.tencent.com/".sslVerify false
          git config --global http."https://git.code.tencent.com/".sslBackend schannel
          git config --global http."https://git.code.tencent.com/".version HTTP/1.1
          
          # Set longer timeouts
          git config --global http.lowSpeedLimit 0
          git config --global http.lowSpeedTime 999999
          git config --global http.timeout 600
          
          # User configuration
          git config --global user.email "action@github.com"
          git config --global user.name "GitHub Actions"
          
          Write-Host "Git SSL configuration completed"
          
          # Show current Git configuration
          Write-Host "Current Git HTTP configuration:"
          git config --list | Where-Object { $_ -like "*http*" }

      - name: Test network connectivity and get SSH keys
        shell: pwsh
        run: |
          Write-Host "Getting SSH host key for Tencent Git..."
          $sshDir = "$HOME\.ssh"
          ssh-keyscan git.code.tencent.com >> "$sshDir\known_hosts"
          Write-Host "✅ SSH key added to known_hosts"

      - name: git clone 
        run: |
          git clone ${{ github.event.client_payload.gitaddress }}
          # git clone git@gitee.com:charlesabc/myutils.git ./${{ github.event.client_payload.project_name }}/myutils
          # ls ./${{ github.event.client_payload.project_name }}
         
      - name: Add MSBuild to PATH
        uses: microsoft/setup-msbuild@v2
        with:
          vs-prerelease: true

      - name: Setup NuGet
        uses: nuget/setup-nuget@v1
        with:
          nuget-version: 'latest'

      - name: Restore NuGet packages
        shell: pwsh
        run: |
          $solutionPath = "smartscan\smartscan.sln"
          
          Write-Host "Restoring NuGet packages for: $solutionPath"
          nuget restore $solutionPath -NonInteractive -Verbosity normal
          
          if ($LASTEXITCODE -eq 0) {
            Write-Host "✅ NuGet packages restored successfully"
          } else {
            Write-Host "❌ NuGet restore failed with exit code $LASTEXITCODE"
            exit $LASTEXITCODE
          }

      - name: Verify build environment
        shell: pwsh
        run: |
          Write-Host "=== Build Environment Information ==="
          Write-Host "MSBuild version:"
          msbuild -version
          
          Write-Host "Current directory:"
          Get-Location
          
          Write-Host "Directory contents:"
          Get-ChildItem -Force | Format-Table Name, LastWriteTime, Length
          
          $PROJECT_NAME = $env:PROJECT_NAME
          Write-Host "Project name: $PROJECT_NAME"
          
          # Look for solution files
          Write-Host "Searching for .sln files..."
          Get-ChildItem -Recurse -Filter "*.sln" -ErrorAction SilentlyContinue | ForEach-Object {
            Write-Host "Found solution: $($_.FullName)"
          }

      - name: Build with MSBuild
        shell: pwsh
        run: |
          $actualProjectDir = "smartscan"
          $solutionPath = "$actualProjectDir\smartscan.sln"
          
          Write-Host "Building solution: $solutionPath"
          
          # Direct build with package restore
          msbuild $solutionPath -t:Restore,Build -p:Configuration=${{ matrix.configuration }} "/p:Platform=${{ matrix.platform }}" -p:RestorePackagesConfig=true -maxcpucount
          
          if ($LASTEXITCODE -eq 0) {
            Write-Host "✅ Build completed successfully"
            echo "BUILD_SUCCESS=true" >> $env:GITHUB_ENV
            echo "BUILD_PROJECT_DIR=$actualProjectDir" >> $env:GITHUB_ENV
          } else {
            Write-Host "❌ Build failed with exit code $LASTEXITCODE"
            exit $LASTEXITCODE
          }

      # Prepare build artifacts for upload
      - name: Prepare build artifacts and zip
        shell: pwsh
        run: |
          $binPath = "smartscan\smartscan\bin\Release"
          $zipFileName = "smartscan-release.zip"
          
          Write-Host "Creating zip file: $zipFileName"
          Compress-Archive -Path "$binPath\*" -DestinationPath $zipFileName -Force
          
          $zipSize = [math]::Round((Get-Item $zipFileName).Length / 1MB, 2)
          Write-Host "✅ Build artifacts zipped successfully: $zipFileName ($zipSize MB)"
          echo "HAS_ARTIFACTS=true" >> $env:GITHUB_ENV

      # Upload to remote server via SCP
      - name: Upload to remote server
        if: success() && env.HAS_ARTIFACTS == 'true'
        shell: bash
        run: |
          echo "Uploading smartscan-release.zip to remote server..."
          scp -o StrictHostKeyChecking=no smartscan-release.zip xhpadmin@download.happygogo.site:/www/wwwroot/download.happygogo.site/autoexam/paper
          
          if [ $? -eq 0 ]; then
            echo "✅ File uploaded successfully to remote server"
          else
            echo "❌ Failed to upload file to remote server"
            exit $?
          fi

      # # Upload zip file
      # - name: Upload build artifacts (zip file)
      #   uses: actions/upload-artifact@v4
      #   if: success() && env.HAS_ARTIFACTS == 'true'
      #   with:
      #     name: smartscan-build
      #     path: "smartscan-release.zip"
      #     retention-days: 1  # Very short retention
      #     if-no-files-found: error
